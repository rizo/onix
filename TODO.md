
# TODO

- [x] Proper support for opam repo management.
- [x] Implement depexts.
- [x] Warn on md5 hashes.
- [x] Refactor builder.nix.
- [x] Refactor overrides.
- [x] Better depexts mapping:
  - https://github.com/tweag/opam-nix/blob/8062dfe742f6636191017232ff504f6765a7f2d1/src/overlays/external/debian.nix#L35
- [x] Filter invalid depexts names.
- [x] Run opam actions natively with Bos.
- [x] Apply "with-test" var when extracting install.
- [x] Use native nixpkgs to build onix itself.
- [x] Use the same compiler for onix and project build.
- [x] Drop fpath, use OpamFilename.
- [x] Improve logging.
- [x] Properly fix ocaml env var export for deps.
  - Using hooks seems is problematic due to multi-export (fails with "Argument list too long").
  - Computing the dep closure is more deterministic albeit potentially costly.
- [x] Replace build ctx json with OCAMLPATH lookup.
  - [ ] Consider installing the opam file as $libdir/$pkg/onix-opam or even overwritting ./opam.
- [ ] ~~Do we need to include `opam` in build ctx json or can we pass repo-url?~~
  - ~~Do we really want opam files for all deps (for opam's `depends` var)?~~
- [ ] Define build/test/dev dependencies separately in lock file?
- [ ] Handle strange version names in nix paths (like dream-pure-1.0.0-alpha2).
  - So we can correctly set up buildInputs/nativeBuildInputs, etc.
- [ ] Make dev tools work: vscode/vim plugins.
- [ ] Fix ocaml env vars propagation for shell.
- [ ] Use nix-prefetch-url.
- [ ] Remove empty libdir after install (should at least have opam!!)?
- [x] Handle .config files (like conf-binutils.config). Is this related to opam's `flag: conf`.
  - https://github.com/tweag/opam-nix/blob/8062dfe742f6636191017232ff504f6765a7f2d1/src/builder.nix#L358
  - Generated on build: https://github.com/ocaml/opam-repository/blob/00777c1a37b2eac5e802e10570a76c89bc5d221e/packages/conf-binutils/conf-binutils.0.3/opam#L9
  - The vars from config files should be loaded into env/vars for a package that depends on the package providing the config file.
  - The `flags: conf` is probably to indicate to opam to load the .config files after build, if any.
  - Could be loaded via OPAM_VAR_xxx with a hook?
  - The .config files also contain additional files, do we really want to copy them?
    - This is because in some cases they will actually resolve to nix paths.
    - [x] An approach alternative to setting OPAM_VAR_xxx is to explicitly lookup vars in Build_context from the saved `onix-propagated-opam-vars` file.
    - [x] Cache the `Dot_config` file as it's likely to be accessed multiple times.
- [ ] Document that opam vars can be set by defining OPAM_VAR_pkg_name.
- [ ] Consider using opaline.
  - Or we could even intall ourselves with OpamFile.Dot_install.
  - https://docs.ocaml.pro/docs/LIBRARY.opam_format@opam-format.2.0.8/OpamFile/Dot_install/index.html
- [ ] Implement onix shell.
- [ ] Implement onix build.
- [x] Use builtins.foldlâ€™.
- [ ] Use builtins.filterSource for ./. src to exclude unwanted dirs (gitignore, _build).
- [ ] Add --lock-file argument to actions.
- [ ] Add a command similar to `opam var` to lookup package variables?
- [ ] Support zip unpacking (tezos?).
- [ ] Improve error-handling.
- [ ] Build any package without a project `onix build utop` or similar.
- [ ] ~~Make depends/depexts optional fields.~~ No longer needed for new build context.
- [ ] Handle empty lock file.
- [ ] Fetch opam extra-source files.
- [ ] Always patch shebangs?
- [ ] Add an example with overrides.
- [ ] Use to sets for depexts: nix * other instead of nix | other.
- [ ] Support static compilation.
- [ ] Handle setenv and build-env.
- [ ] Support cross-compilation.
- [ ] Decide how to support dependency flags:
  - with-build
  - with-test
  - with-doc
  - with-dev/with-tools?
- [ ] Add flakes support.
- [ ] Use strictDeps. This will require handling conf- packages in the lock file.
- [ ] Ensure valid pkg names (exclude ~).
- [ ] Handle lock file without ocaml.
- [ ] Changing project's opam file currently triggers full scope rebuild?
- [ ] Version the lock file.
  - Add version, packages and repo fields.
- [ ] Consider using joinSymlinks to create a build scope.
- [ ] Nix store path parsing does not work for `nix develop`.
- [ ] Should the lock file include transitive deps already?
- [ ] Stop using emptyPkg.
